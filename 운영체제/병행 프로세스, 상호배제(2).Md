# 병행 프로세스, 상호배제(2)

1. 상호배제, 동기화

**둘 이상의 프로세스가 공유할 수 없는 자원을 임계자원이라 하며, 프로그램에서 이를 이용하는 부분**
- 공유 메모리가 참조되는 프로그램의 부분(데이터, 데이터 구조)으로 다수의 프로세스가 접근가능한 영역이면서 한 순간에 하나의 프로세스만 사용할 수 있는 영역(공유자원의 독점을 보정하는 코드 영역)을 의미
- 프로세스들이 공유 데이터를 통해 협력 시, 한 프로세스가 임계영역에 들어가면 다른 모든 프로세스는 임계영역으로의 진입 금지
- 다중 처리 시스템과 단일 처리 시스템(시분할)환경에 적용되는 하나의 실행단위, 실행 구간을 의미
- 임계영역 내에서 빠른 속도로 작업을 수행, 한 프로세스가 오랫동안 머무르면 안된다.
- 프로세스가 무한 루프등에 빠지지 않도록 관리해야한다.

**진입 상호배제**
- 프로세스 하나가 임계영역에 있으면 다른 프로세스가 임계영역에 들어가지 못하게 하는 것.
- 임계영역에 들어가기를 원하는 프로세스는 진입 상호배제를 수행해야한다.
  - 프로세스가 접근하지 않는 임계영역은 잠금 상태
  - 프로세스는 임계영역에서 작업을 수행하기전에 키를 얻어 임계영역의 잠금 상태를 해제해야한다.
  - 프로세스가 키를 반환할 때까지 다른 모든 프로세스에 대해 잠김 상태 유지
  - 임계영역을 떠나는 프로세스는 출구 상호배제를 수행함으로써 다른 프로세스가 임계영역에 들어갈 수 있도록 한다.
  - 프로세스들이 서로 협력하여 자원을 사용할 수 있도록 프로토콜을 설계하여 임계영역 문제를 해결 가능

**임계영역을 해결하기 위해 아래 세 가지 요구를 만족시켜야한다.**
- 상호배제 : 프로세스 p^i가 임계영역에서 수행 중일 때 다른 프로세서는 임계영역에서 수행할 수 없다.
- 진행 : 임계영역에서 수행하는 프로세스가 없고 여러개의 프로세스가 임계영역으로 들어가려고 하면 프로세스 선정 알고리즘에 따라 다음 임계영역으로 들어가려고 하면 프로세스 선정 알고리즘에 따라 다음 임계영역에서 수행할 대상을 선정한다. / 다음 임계영역으로 들어갈 프로세스 선택은 무한정 미룰 수 없다.
- 제한된 대기 : 한 프로세스가 임계영역을 요청한 후 요청이 수락되기까지 다른 프로세스가 임계영역에 진입할 수 있는 횟수를 제한해야한다.


**단일 프로세서, 메모리 공유하는 다중 처리 환경의 프로세서가 존재**
- 하드웨어의 도움없이 프로세스 두 개의 상호배제 문제를 해결

**특별한 하드웨어 명령을 사용, 임계영역 문제를 해결가능**
- 기계를 비교하거나 단어 내용을 검사 및 수정 또는 내용을 바꾸는(Swap) 명령을 사용하여 임계영역 문제 해결
- 하나의 기억장치 사이클에서 수행되므로 생산자 / 소비자 문제에서 예로 든 counter 변수 수정에 발생하는 문제 해결 가능

**testandest를 이용한 상호배제 알고리즘**
- testandest (a, b); 는 논리변수 b를 읽어 a에 복사하고, b를 참으로 하는 명령
- 단일 프로세서, 메모리를 공유하는 다중 처리 환경과 관계없이 적용되며, 간단하여 쉽게 적용된다는 장점을 가진다.
- 임계영역에 진입하려는 프로세스에 바쁜 대기가 발생
- 무한 연기 가능성이 발생할 수 있지만 프로세스 수가 많으면 거의 발생하지 않는다.

**음이 아닌 정수값을 갖는 플래그 변수**
- 다익스트라가 상호배제의 문제를 극복하기 위해 제안
- 세마포어의 유명한 예) '열차의 진행 가능 여부' 를 나타내는 차단기

**세마포어 정의**
- 프로세스 동기화 문제 해결을 위한 두 가지 연산(p, v)
- p : 네덜란드어로 검사를 나타내며, 프로세서를 대기시키는 wait 동작으로 임계영역에 진입하기 위한 연산
- v : 네널란드어로 증가를 나타내며, 대기중인 프로세스를 깨우는 신호를 보내는 signal 동작으로 임계영역에서 나오기 위한 연산
- s : 세마포어를 나타내며 표준 단위 연산 p, v 에 의해서만 접근되는 정수 변수
- 프로세스 제어를 용이하게 하며 p 연산을 요구하는 프로세서는 그 동작이 수행 가능한 상태가 될 때까지 대기
- p, v 연산은 세마포어 변수 s를 수정하는데 사용되나, 표시한 프로세스가 변수 s를 수정하면 다른 프로세스를 수정할 수 있다.

**세마포어 사용**
- 세마포어는 프로세스 n개의 임계영역 문제를 다루는 데 사용
- 세마포어는 여러가지 동기화 문제를 다루는 데 사용

**세마포어 구현**
- 세마포어는 제어된 변수로, p, v의 초기 작업 때만 값이 변할 수 있다.
- 이진 세마포어는 0, 1 값만 가진다.
- 한 프로세스가 임계영역에 있을 때, 임계영역에 들어가기를 원하는 다른 프로세스가 진입코드를 계속 순환하여 프로세스 시간 낭비
- 이를 극복하기 위하여 세마포어의 wait, signal 동작을 수정
- 프로세스가 wait 동작을 실행하고 세마포어의 값이 양수가 아닐 경우 프로세스는 대기한다.
- 다음 제어는 프로세서 스케줄러에 넘기고 프로세서는 준비 큐에서 다른 프로세스를 선택
- 세마포어 s에 의해 블록 / 대기 중인 프로세스는 다른 프로세스가 signal 동작을 실행해야 재시작 가능
- 프로세서는 wakeUP 동작에 의해 재시작되고, 대기상태에서 준비 상태로 변경, 준비 큐에 놓인다.
- 이를 바탕으로 다음과 같은 레코드 정의 가능
- 세마포어는 block / wakeUP 동기화를 구현하는 메커니즘으로도 사용한다.
- 프로세서 리스트는 각 프로세스제어블록(PCB)의 링크 필드의 정보를 이용해 구현가능하다.

**프로그래밍 언어에서 제공되는 프로그래머 정의 연산자들의 집합으로 구성**
- 세마포어의 p, v 연산이 프로그램 전체에 퍼져 있으며, 이들 연산이 미치는 영향을 전체적으로 파악하기 쉽지 않아 프로그램 작성이 어려운 단점을 극복하기 위함이다.
- 핸슨(Brich Hanse), 호(Hoare) 가 개발
- 모니터의 형태 표현은 변수 선언으로 구성, 변수 값이 형태를 정의한다.
- 모니터의 문법 구조

**모니터의 구조**
- 하나 이상의 프로시저, 초기화 코드, 공유 데이터로 구성된 소프트웨어 모듈로 이루어진 객체
- 모니터 안에 정의된 프로시저는 모니터 내에서 지역적으로 정의된 변수의 형식 매개변수들만 접근 가능
- 모니터 경계에서 한 번에 한 프로세스만 진입하도록 제어되므로 상호배제 원칙을 지킨다.
- 자원 반납 시 모니터 진입 루틴 호출

**모니터의 조건 변수**
- 임계영역과 유사하며, 프로세스가 실행되는 동안 상호배제, 동기화 제공
- 조건 임계영역으로 확장되었으며, 동기화를 위한 부수 기법이 필요하다.
- 모니터 밖의 프로세스가 대기 시 조건 변수에 의해 수행 재개가 결정된다.
- wait, signal 연산 만이 호출 가능
- 모든 조건 변수는 관련된 큐가 있기 때문에 wait를 호출하는 프로세스는 해당 조건 변수와 연관된 큐에 놓인다.

**x.wait 연산**
- 어떤 프로세스가 x.signal 을 호출할 때 까지 x.wait을 호출한 프로세스는 연기/중단된다는 의미
- 프로세스 p가 x-signal 연산 호출 시 조건 x와 연관되고 중단된 프로세스 q가 있다고 가정 시 두 가지 가능성이 존재
- 호(Hoare)는 p가 이미 모니터 안에서 실행되기때문에 후자를 선택하는 것이 합리적이라 주장
- 핸슨은 병행 파스칼 언어에서 이 두 가지 선택사항을 절충하여 적용
- 프로세스 p가 signal 연산을 실행하며 즉시 모니터를 떠나고 q가 즉시 재 실행된다.(신호 후 종료 기법)
- 새로운 기법은 경쟁하는 프로세서 사이에서 단일 자원 할당을 제어한다.


