# 교착상태와 기아상태(1)

1. 교착상태 개요
- 교착상태(DeadLock)의 개념
> 시스템 측면에서 자원의 요구가 뒤엉킨 상태를 말한다.  
한 프로세스 집합 내의 프로세스들에 의해 발생할 사건(Event)를 프로세스들이 서로 기다리고 있는 상태  
둘 이상의 작업이 보류 상태에 놓여 중요한 자원을 이용하기 위해 기다릴 때 발생한다.  
제한된 자원 이용률을 높이고 시스템 효율성을 증가시키기 위해 사용하는 병행처리기술과 자원 공유에 따른 부작용이다.

- 초기 일괄처리시스템
> 사용자들이 작업제어카드에 작업을 완료하기 위해 필요한 자원을 명시하여 교착상태가 자주 발생하지 않는다.  
운영체제가 요청한 자원이 준비 큐로 이동하기 전 사용 가능 여부를 확인하여 할당한다.  
자원이 확보되지 않으면 작업이 준비 큐로 이동할 수 없어 교착상태가 발생하지 않는다. 

---
- 대화식시스템
> 동적 자원 공유로 자원의 이용도를 높이는 과정에서 교착상태 발생!
  - DVD 드라이브와 프린트가 각각 하나씩 존재하고 다음과 같은 경우
    - 프로세스 P : DVD 드라이브 점유 >> 프린터 요청
    - 프로세스 Q : 프린터 점유 >> DVD 드라이브 요청
  - 테이프 드라이브가 3개 존재하고 다음과 같은 경우
    - 프로세스 P : 테이프 드라이브 점유
    - 프로세스 Q : 테이프 드라이브 점유
    - 프로세스 R : 테이프 드라이브 점유

---
- 프로세스는 다음순서로 자원을 이용한다.
  - 요청 : 프로세스가 자원을 요청한다. 요청을 즉시 받아들여지지 않으면 다른 프로세스가 사용 중이므로 할당 받을 때까지 대기한다.
  - 사용 : 프로세스가 요청한 자원을 사용한다.
  - 해제 : 프로세스가 자원 사용을 마친 후, 할당 받은 자원을 되돌려준다.
    - 자원의 요청과 해제 그리고 파일이나 입출력 장치를 읽거나 쓰는 자원의 사용도 시스템 호출에 의해 이루어진다.
    - 운영체제는 프로세스가 자원 요청 시, 할당 받을 수 있도록 항상 확인하고 기록한다.
---
- 교착상태 발생
> 파일을 요청할 때의 교착상태  
파일을 이용해 작어빙 실행되는 동안, 파일에 대한 다른 작업의 점유 요청이 인정되면 교착상태 발생
- 파일 요청 시 발생하는 교착상태
  - 두 개의 프로세스(판매, 재고)와 두 개의 파일 (공급자 파일, 재고 파일) 자원을 이용한 교착상태 표현

- 할당 요구 순서
  - 프로세스 1 (판매)는 판매 계획을 위해 공급자 파일을 요청해서 얻는다.(할당)
  - 프로세스 2 (재고)는 재고 확인을 위해 재고 파일을 요청해서 얻는다. (할당)
  - 프로세스 1은 주문 요청한 판매를 위해 재고 파일을 요청하지만 허용되지 않는다.
  - 프로세스 2는 주문을 위해 공급자 파일을 요청하지만 허용되지 않는다.

- 전용장치를 할당할 때의 교착상태
  - 전용장치 할당 시 발생하는 교착상태
    - 두 사용자(프로세스 1, 프로세스 2)가 각각 테이프 드라이브 한 대를 사용하고, 한 테이프에서 다른 테이프로 복사하는 작업을 할 경우
    - 할당 요구 순서는 다음과 같이 이루어진다 가정
> 프로세스 1은 테이프 드라이브 1을 요청해서 얻는다. (할당)  
프로세스 2는 테이프 드라이브 2를 요청해서 얻는다. (할당)  
프로세스 1는 테이프 드라이브 2를 요청하지만 허용되지 않는다.  
프로세스 2는 테이프 드라이브 1을 요청하지만 허용되지 않는다.

---
- 스풀링 시스템에서의 교착상태
> 스풀링 시스템에서 디스크에 할당된 스풀 공간의 출력이 완료되지 않은 상태에서 다른 작업이 스풀 공간을 모두 차지하면 교착상태가 발생  
스풀링 처리부(Input Sppoler)에 필요량보다 많은 공간을 배당하여 교착상태 발생률을 줄일 수 있으나 비용이 많이 든다.  
스풀링 파일이 '일정 포화 임계치(Saturation Treshold)'를 설정하여 교착상태를 예방할 수 있으나 시스템의 처리량이 줄어들 수 있다.

---
- 디스크를 공유할 때의 교착상태
> 디스크는 대표적인 공유 자원으로, 사용에 대한 제어가 없다면 교착상태가 발생할 수 있다.

- 네트워크에서의 교착상태
> 네트워크가 붐비거나 입출력 버퍼공간이 부족한 네트워크 시스템이 메시지 흐름을 제어하는 적절한 프로토콜을 가지지 못한 경우 교착상태 발생

---
- 교착상태 발생조건
> 상호배제 : 자원이 최소 하나 이상 비 공유, 즉 한번에 한 프로세스만 해당 자원을 사용할 수 있어야한다. 사용 중인 자원을 다른 프로세스가 사용하려면 요청한 자원이 해제 될 때 까지 대기해야한다.  
점유와 대기 : 최소한 자원 하나를 보유하고 다른 프로세스에 할당된 자원을 얻기 위해 기다리는 프로세스가 있어야한다.  
비선점 : 자원은 선점될 수 없다. 즉 자원을 강제로 뺏을 수 없으며 자원을 점유하고 있는 프로세스가 끝나가 있어야한다.  
순환대기 : 대기 프로세스 집합이 있을 때 보유하고 있는 자원을 각각 얻기 위해 대기하는 경우 
- 강건너기 교착상태
  - 여러 개의 돌로 된 징검다리가 있는 강을 건너는 경우
  - 징검다리의 둘 하나는 한 쪽에서 한 사람만 디딜 수 있다. (상호배제 성립)
  - 강을 건너는 사람을 프로세스, 징검다리의 돌을 자원이라 가정한다.
  - 두 사람이 동시에 서로 다른 방향에서 출발, 강 중간에서 만나면 교착상태가 발생했다 할 수 있다.
  - 돌을 딛는 것을 자원 할당, 발을 떼는 것을 자원 해제로 볼 때 동시에 같은 돌을 딛이려 하면 교착상태가 발생한다.
  - 각 사람은 돌 하나를 딛고 다음 돌을 요구한다. (점유와 대기 조건 만족)
  - 사람이 딛고 있는 돌을 강제로 제거할 수 없다. (비선점 조건 만족)
  - 왼쪽에서 오는 사람은 오른쪽 사람을, 오른쪽에서 오는 사람은 왼쪽 사람을 기다린다. (순환대기 조건 만족)

- 해결 방법
  - 둘 중 한 사람이 되돌아간다. (복귀)
  - 강을 건너기 전에 상대편 강 쪽을 확인하고 출발한다.
  - 강의 한 쪽 편에 우선권을 부여한다.

2. 교착상태 해결 기법
- 교착상태를 해결하는 기법은 크게 3가지로 나눈다.
  - 시스템이 교착상태가 되지 않도록 예방하는 것.
  - 가능한 교착상태를 회피하는 것
  - 교착상태를 허용하되 교착상태에서 다시 회복할 수 있게 하는 것 (사용하기 어렵고 오버헤드가 증가)

- 교착상태 예방 기법
  - 4가지의 교착상태 조건 중 하나라도 발생하지 않도록 한다.
    - 상호배제 문제는 고려해야한다. (전용자원에서 교착상태가 발생하지 않으므로 프로세스가 원하는 자원을 배타적으로 사용하려는 것은 제외시켜야한다.)
    - 하벤더(Havender, 1986년)이 상호배제를 제외한 세 가지 기본 방법 제안 
> 각 프로세스는 한 번에 필요한 모든 자원을 요구해야 하며, 요청한 자원을 모두 제공받기 전까지는 작업을 진행할 수 없다.  
어떤 자원을 점유하고 있는 프로세스의 요구가 더 이상 허용되지 않으면 점유한 자원을 모두 반납하고 필요할 때 다시 자원을 요구해야 한다.  
모든 프로세스에 자원을 순서대로 할당해야 한다. 모든 프로세스에 각 자원을 유형별로 할당 순서를 부여한 후, 순서에 따라 자원을 요구한다.  

- 상호배제 조건 방지
  - 상호배제 조건은 자원의 비공유를 전제로 한다.
    - 공유 가능한 자원들은 배타적인 접근을 요구하지 않으므로 교착상태가 발생하지 않는다.
  - 일반적으로 상호배제 조건을 거부하면 교착상태를 예방하는 것이 불가능하다.
    - 어떤 자원은 공유 자체가 불가능한 것도 있다.
  - 파일 쓰기는 배차적인 접근만이 허용되어야한다.
    - 하나 이상의 프로세스가 쓰기 권한을 가지면 교착상태가 발생할 가능성이 있다.

- 점유와 대기 조건 방지 
  - 최대 자원 할당
    - 프로세스가 작업을 수행하기 전에 필요한 모든 자원을 요청하고 획득해야한다.
    - 보류 상태에서는 프로세스가 자원을 점유할 수 없으므로 대기 조건이 성립하지 않는다.
  - 점유와 대기 조건 방지를 위한 두 가지 방법
    - 모든 프로세스는 자원을 요청하고 사용할 수 있다.
    - 프로세스가 자원을 더 요청하려면 먼저 자신에게 할당된 자원을 해제해야한다.

- 단점
  - 자원의 효율성이 낮다.
    - 많은 자원이 사용되지 않으면서 오랜 시간 할당되기 때문이다.
  - 기아상태 발생이 가능하다.
    - 자주 쓰는 자원이 다른 프로세스에 할당된 경우, 자원을 요청한 프로세스는 무한히 기다려야하는 경우가 발생한다.
    - 적은 수의 자원을 요청한 프로세스와 우선순위가 높으므로, 많은 수의 자원을 요청한 프로세스의 대기 시간이 길어질 수 있다.

- 비선점 조건 방지
  - 이미 할당된 자원에 대한 선점권이 없어야 한다는 전제조건을 가진다.
    - 어떤 자원을 가진 프로세스가 자원 요청 시 기다려야 한다면, 프로세스는 현재 가진 자원을 모두 해제한다.
    - 프로세스가 작업을 시작하려면 요청한 새로운 자원과 해제한 자원을 확보해야한다.
    - 작업 상태를 쉽게 저장 및 복구 가능할 때 또는 빈번하게 발생하지 않을 때만 좋은 수단으로 이용 가능하다.

- 비선점 조건 방지 - 대안
  - 프로세스가 어떤 자원을 요청할 때, 요청한 자원이 사용 가능한지 검사한다.
    - 사용가능하다면 자원 할당, 사용 불가능한 경우 대기 프로세스가 요청한 자원을 점유하고 있는지 검사한다.
    - 요청한 자원을 대기 프로세스가 선점하고 있다면, 자원을 해제하고 요청 프로세스에 할당한다.
    - 요청한 자원을 사용할 수 없거나, 실행 중인 프로세스가 점유하고 있다면 요청 프로세스는 대기한다.
  
  - 두 프로세스에 우선순위를 부여하여, 높은 우선순위의 프로세스가 그 보다 낮은 순위의 프로세스가 점유한 자원을 선점하여 해결한다.
    - 프로세스 레지스터나 기억장치 레지스터와 같이 쉽게 저장되고 이 후 복원이 쉬운 자원에 이용한다.

- 순환대기 조건 방지
  - 계층적 요구 기법
    - 모든 자원에 일련의 순서를 부여, 각 프로세스는 오름차순으로만 자원을 요청할 수 있게 한다.
    - 순환대기의 가능성을 제거하여 교착상태를 예방한다.
    - 예상된 순서와 다르게 자원을 요구하는 작업은 자원 낭비를 초래한다.
    - R = {R1, R2... Rn}을 자원 형태 집합이라 가정하고, 각 자원 형태에 고유 숫자를 부여한다.

- 1:1함수인 'F:R >> N'으로 정의 가능하며, N은 자연수 집합을 의미한다.
  - 프로세스는 임의의 자원 RI를 요청할 수 있지만 그 다음부터는 'F(RJ) >> F(RI)'인 경우에만 자원 형태 RJ를 요청할 수 있다.
  - 프로세스가 자원 형태 RJ를 요청할 때마다 'F(RJ) >= F(RJ)'가 되도록 RJ의 모든 자원을 해제한다.

- 모순에 의한 증명 >> 순환대기가 성립한다는 가정에서 사실의 성립
  - 순환대기의 프로세스 집합을 {P1...PN}이라 가정하며, PI는 프로세스 PI + 1이 점유하고 있는 자원 RI를 대기한다.
  - 프로세스는 PI + 1은 자원 RI + 1을 요청하는 동안 자원 RI를 점유하고 있으므로, 모든 I에 대하여 'F(RO) < F(RI) < ... < (RN) < F(RO)'이 성립함을 의미한다.
  - 즉, 'F(RO) < F(RO)'는 불가능하므로, 여기에 순환대기가 있을 수 없다.
  - 함수 F는 시스템에 있는 자원의 정상적인 이용 순서에 따라서 정의되어야한다.

- 계층적 요구의 단점
  - 순환대기 조건 가능성을 제거하여 교착상태를 예방하지만, 반드시 그 자원이 가진 번호 순서로 요구해야 한다는 부담(자원 요구 순서 예측)이 있다.
  - 번호 부여 시 실제로 자원을 사용하는 순서를 반영해야한다.

---
- 교착상태 회피 기법
  - 교착상태의 예방보다 덜 엄격한 조건을 요구함으로써 자원을 좀 더 효율적으로 이용하는 것을 목적으로 한다.
  - 교착상태가 일어날 가능성을 인정하고 (세 가지 필요조건 허용) 교착상태가 일어나려고 할 때 적절히 회피하며, 이는 예방보다 더 병행성을 허용한다.

- 회피기법 두 가지 방법
  - 프로세스의 시작 거부
    - 프로세스의 요구가 교착상태를 일으킬 수 있다면 프로세스 시작을 중지한다.
    - 현재 수행중인 모든 프로세스의 최대 자원 요구량과 새로운 프로세스의 최대 요구량을 합한 자원요구량을 수용할 수 있으면 새로운 프로세스를 수용
  - 자원 할당의 거부
    - 프로세스가 요청한 자원을 할당했을 때, 교착상태가 발생할 수 있다면 요청한 자원을 할당하지 않는다.
    - 일반적으로 은행가 알고리즘이라 부른다.

  - 교착상태 회피를 위해 자원이 언제 요구되는지에 대한 추가 정보가 필요하다.
    - 각 프로세스마다 요청과 해제에 대한 정확한 순서를 파악하고 있다면 요청에 따른 프로세스 대기 여부를 결정 가능하다.
  - 요구를 받아들일 지 또는 기다리게 할지를 결정하기위해 각 프로세스에 대한 요구와 해제를 미리 알고 있어야한다.
    - 필요한 정보의 양과 종류에 따라 다양한 교착상태 회피 알고리즘을 적용할 수 있다.
    - 프로세스가 요청할 자원마다 최대치 정보를 미리 파악할 수 있다면 시스템이 교착상태가 되지 않을 확실한 알고리즘을 만들 수 있다.

- 안정상태와 불안정상태
  - 교착상태 회피 알고리즘은 시스템이 순환-대기 조건이 발생하지 않도록 자원 할당 상태를 검사한다.
  - 자원 할당 상태는 사용 가능한 자원의 수, 할당된 자원의 수, 프로세스들의 최대 요구 수에 의해 정의된다.

  - 안정상태
    - 각 프로세스에 자원을 할당할 수 있고 (최대치까지), 교착상태를 방지할 수 있다.
  - 불안정상태
    - 안정상태처럼 프로세스의 자원 할당 및 해제의 순서가 명확히 존재하지 않는 경우
    - 교착상태는 불안정상태이나, 모든 불안정상태가 교착상태인 것은 아니다.

- 시스템 상태변화
- 교착상태 회피 : 은행가 알고리즘

